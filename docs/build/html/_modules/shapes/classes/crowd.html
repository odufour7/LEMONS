

<!DOCTYPE html>
<html class="writer-html5" lang="english" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>shapes.classes.crowd &mdash; shapes project 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=14667faf"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            shapes project
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/shapes/create2Dped.html">Create a 2D pedestrian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/shapes/create3Dped.html">Create a 3D pedestrian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/shapes/read_database.html">Read the ANSURII database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">shapes project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">shapes.classes.crowd</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for shapes.classes.crowd</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module containing the Crowd class, which represents a crowd of pedestrians in a room.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">shapes.utils.constants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cst</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapes.classes.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapes.classes.measures</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CrowdMeasures</span><span class="p">,</span>
    <span class="n">create_bike_measures</span><span class="p">,</span>
    <span class="n">create_pedestrian_measures</span><span class="p">,</span>
    <span class="n">draw_agent_measures</span><span class="p">,</span>
    <span class="n">draw_agent_type</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapes.utils.typing_custom</span><span class="w"> </span><span class="kn">import</span> <span class="n">ShapeDataType</span>


<div class="viewcode-block" id="Crowd">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Crowd</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class representing a crowd of pedestrians in a room.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">measures</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="n">CrowdMeasures</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">agents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Agent</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boundaries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Polygon</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the class instance with measures, agents, and boundaries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        measures : dict[str, float] | dict[int, dict[str, float]] | CrowdMeasures | None, optional</span>
<span class="sd">            Crowd measures data. Can be:</span>
<span class="sd">                - A dictionary of agent statistics (str keys, float values)</span>
<span class="sd">                - A custom database (int keys, dict values)</span>
<span class="sd">                - A CrowdMeasures instance</span>
<span class="sd">                - None (default), which creates a default CrowdMeasures object</span>
<span class="sd">        agents : list[Agent] | None, optional</span>
<span class="sd">            List of Agent instances. If None, an empty list is used.</span>
<span class="sd">        boundaries : Polygon | None, optional</span>
<span class="sd">            A shapely Polygon instance defining the boundaries.</span>
<span class="sd">            If None, a default large square boundary is created.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `measures` is not of the expected types.</span>
<span class="sd">            If `agents` is not a list of Agent instances.</span>
<span class="sd">            If `boundaries` is not a shapely Polygon instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">measures</span> <span class="o">=</span> <span class="n">CrowdMeasures</span><span class="p">(</span><span class="n">custom_database</span><span class="o">=</span><span class="n">measures</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">measures</span> <span class="o">=</span> <span class="n">CrowdMeasures</span><span class="p">(</span><span class="n">agent_statistics</span><span class="o">=</span><span class="n">measures</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">elif</span> <span class="n">measures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">measures</span> <span class="o">=</span> <span class="n">CrowdMeasures</span><span class="p">()</span>  <span class="c1"># Create a default CrowdMeasures object</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">CrowdMeasures</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`measures` should be an instance of Measures or a dictionary.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">agents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">Agent</span><span class="p">)</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;agents&#39; should be a list of Agent instances&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">boundaries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">boundaries</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)),</span>
                    <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">),</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">),</span>
                    <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">),</span>
                    <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundaries</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;boundaries&#39; should be a shapely Polygon instance&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_measures</span><span class="p">:</span> <span class="n">CrowdMeasures</span> <span class="o">=</span> <span class="n">measures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Agent</span><span class="p">]</span> <span class="o">=</span> <span class="n">agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundaries</span><span class="p">:</span> <span class="n">Polygon</span> <span class="o">=</span> <span class="n">boundaries</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Agent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of agents in the crowd.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[Agent]</span>
<span class="sd">            A list containing all the agents in the crowd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agents</span>

    <span class="nd">@agents</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Agent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the agents of the crowd.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : list[Agent]</span>
<span class="sd">            A list of Agent instances to set as the agents of the crowd.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `value` is not a list or if any element in `value` is not an instance of Agent.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This setter replaces the entire list of agents in the crowd with the provided list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">Agent</span><span class="p">)</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;agents&#39; should be a list of Agent instances&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agents</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">measures</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CrowdMeasures</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the measures of the crowd.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CrowdMeasures</span>
<span class="sd">            A CrowdMeasures object containing the measures of the crowd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_measures</span>

    <span class="nd">@measures</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="n">CrowdMeasures</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the measures of the crowd.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : dict[str, float] | dict[int, dict[str, float]] | CrowdMeasures | None</span>
<span class="sd">            The measures to set for the crowd. Can be:</span>
<span class="sd">                - A dictionary with string keys and float values (agent statistics)</span>
<span class="sd">                - A dictionary with integer keys and dictionary values (custom database)</span>
<span class="sd">                - An instance of CrowdMeasures</span>
<span class="sd">                - None (creates a new default CrowdMeasures instance)</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `value` is a dictionary with keys that are neither all integers nor all strings.</span>
<span class="sd">            If `value` is neither a dictionary, an instance of CrowdMeasures, nor None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">CrowdMeasures</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">first_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">CrowdMeasures</span><span class="p">(</span><span class="n">custom_database</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">CrowdMeasures</span><span class="p">(</span><span class="n">agent_statistics</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dictionary keys must be either all integers or all strings.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">CrowdMeasures</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`measures` should be an instance of CrowdMeasures or a dictionary or None.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_measures</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Polygon</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the boundaries of the room.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Polygon</span>
<span class="sd">            The boundaries of the room as a shapely Polygon object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boundaries</span>

    <span class="nd">@boundaries</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">boundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Polygon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the boundaries of the room.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : Polygon</span>
<span class="sd">            A shapely Polygon instance representing the boundaries of the room.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `value` is not an instance of shapely Polygon.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;boundaries&#39; should be a shapely Polygon instance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_boundaries</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Crowd.get_number_agents">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.get_number_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_number_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of agents in the crowd.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            The number of agents in the crowd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_agents</span><span class="p">)</span></div>


<div class="viewcode-block" id="Crowd.add_one_agent">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.add_one_agent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_one_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new agent to the crowd using available measures data.</span>

<span class="sd">        The agent creation follows this priority:</span>
<span class="sd">        1. Uses agent statistics if available (when custom database is empty)</span>
<span class="sd">        2. Uses custom database if available</span>
<span class="sd">        3. Falls back to default ANSURII database if no other data exists</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Agent creation logic:</span>
<span class="sd">            Case 1 (Agent Statistics):</span>
<span class="sd">                Uses `draw_agent_type` and `draw_agent_measures` to create agent.</span>
<span class="sd">                Requires `measures.agent_statistics` to be populated.</span>
<span class="sd">            Case 2 (Custom Database):</span>
<span class="sd">                Randomly selects from `measures.custom_database`.</span>
<span class="sd">                Creates specific agent types (pedestrian/bike) using `create_*_measures`.</span>
<span class="sd">            Case 3 (Default Database):</span>
<span class="sd">                Uses built-in ANSURII database.</span>
<span class="sd">                Always creates pedestrian agents.</span>
<span class="sd">                Relies on `create_pedestrian_measures`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Case 1: Use agent statistics if available and custom database is empty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">agent_statistics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">custom_database</span><span class="p">:</span>
            <span class="n">drawn_agent_type</span> <span class="o">=</span> <span class="n">draw_agent_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="p">)</span>
            <span class="n">drawn_agent_measures</span> <span class="o">=</span> <span class="n">draw_agent_measures</span><span class="p">(</span><span class="n">drawn_agent_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Agent</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">drawn_agent_type</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="n">drawn_agent_measures</span><span class="p">))</span>

        <span class="c1"># Case 2: Use the custom database if available</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">custom_database</span><span class="p">:</span>
            <span class="n">drawn_agent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">custom_database</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">drawn_agent</span><span class="p">[</span><span class="s2">&quot;agent_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cst</span><span class="o">.</span><span class="n">AgentTypes</span><span class="o">.</span><span class="n">pedestrian</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">agent_measures</span> <span class="o">=</span> <span class="n">create_pedestrian_measures</span><span class="p">(</span><span class="n">drawn_agent</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Agent</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">drawn_agent</span><span class="p">[</span><span class="s2">&quot;agent_type&quot;</span><span class="p">],</span> <span class="n">measures</span><span class="o">=</span><span class="n">agent_measures</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">drawn_agent</span><span class="p">[</span><span class="s2">&quot;agent_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cst</span><span class="o">.</span><span class="n">AgentTypes</span><span class="o">.</span><span class="n">bike</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">agent_measures</span> <span class="o">=</span> <span class="n">create_bike_measures</span><span class="p">(</span><span class="n">drawn_agent</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Agent</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">drawn_agent</span><span class="p">[</span><span class="s2">&quot;agent_type&quot;</span><span class="p">],</span> <span class="n">measures</span><span class="o">=</span><span class="n">agent_measures</span><span class="p">))</span>

        <span class="c1"># Case 3: Use the default ANSURII database if no other data is available</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">agent_statistics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">custom_database</span><span class="p">:</span>
            <span class="n">drawn_agent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">default_database</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">))</span>
            <span class="n">agent_measures</span> <span class="o">=</span> <span class="n">create_pedestrian_measures</span><span class="p">(</span><span class="n">drawn_agent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Agent</span><span class="p">(</span><span class="n">agent_type</span><span class="o">=</span><span class="n">cst</span><span class="o">.</span><span class="n">AgentTypes</span><span class="o">.</span><span class="n">pedestrian</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="n">agent_measures</span><span class="p">))</span></div>


<div class="viewcode-block" id="Crowd.remove_one_agent">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.remove_one_agent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_one_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the most recently added agent from the crowd.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>


<div class="viewcode-block" id="Crowd.create_agents">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.create_agents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create multiple agents in the crowd through repeated additions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        number_agents : int</span>
<span class="sd">            Number of agents to create.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_agents</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_one_agent</span><span class="p">()</span></div>


<div class="viewcode-block" id="Crowd.get_crowd_measures">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.get_crowd_measures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_crowd_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">|</span> <span class="n">CrowdMeasures</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate comprehensive statistics for the current crowd composition.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict[str, float]</span>
<span class="sd">            Dictionary containing aggregated crowd statistics with keys formatted as:</span>
<span class="sd">                - &quot;num_{agent_type}&quot;: Count of agents per type (e.g., &quot;num_pedestrian&quot;)</span>
<span class="sd">                - &quot;{part}_mean&quot;: Mean value for each body/bike part measurement</span>
<span class="sd">                - &quot;{part}_std_dev&quot;: Sample standard deviation for each part</span>
<span class="sd">                - &quot;{part}_min&quot;: Minimum observed value for each part</span>
<span class="sd">                - &quot;{part}_max&quot;: Maximum observed value for each part</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crowd_measures</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Loop over the enumeration of AgentTypes to get the number of pedestrians and bikes</span>
        <span class="k">for</span> <span class="n">agent_type</span> <span class="ow">in</span> <span class="n">cst</span><span class="o">.</span><span class="n">AgentTypes</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">agent_type</span> <span class="o">==</span> <span class="n">agent_type</span><span class="p">)</span>
            <span class="n">crowd_measures</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;num_</span><span class="si">{</span><span class="n">agent_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

        <span class="c1"># Loop over PedestrianParts and BikeParts to get statistics for each measure</span>
        <span class="k">for</span> <span class="n">parts_enum</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cst</span><span class="o">.</span><span class="n">PedestrianParts</span><span class="p">,</span> <span class="n">cst</span><span class="o">.</span><span class="n">BikeParts</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts_enum</span><span class="p">:</span>
                <span class="n">measures</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">measures</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">measures</span><span class="p">:</span>
                    <span class="n">crowd_measures</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">measures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">))</span>
                    <span class="n">crowd_measures</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_std_dev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">crowd_measures</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
                    <span class="p">)</span>
                    <span class="n">crowd_measures</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">measures</span><span class="p">))</span>
                    <span class="n">crowd_measures</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">part</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">measures</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">crowd_measures</span></div>


<div class="viewcode-block" id="Crowd.get_agents_params">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.get_agents_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_agents_params</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">ShapeDataType</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve physical parameters of all agents in a structured format.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with agent IDs as keys (format: &quot;agent{N}&quot;) and values containing:</span>
<span class="sd">                agent_type : str</span>
<span class="sd">                    Agent classification (e.g., &quot;Pedestrian&quot;, &quot;Bike&quot;)</span>
<span class="sd">                weight (kg) : float</span>
<span class="sd">                    Mass of the agent in kilograms</span>
<span class="sd">                moi (kg*m^2) : float</span>
<span class="sd">                    Moment of inertia in kilogram-square meters</span>
<span class="sd">                shapes : ShapeDataType</span>
<span class="sd">                    Geometric parameters of the agent&#39;s 2D representation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crowd_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">ShapeDataType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;agent</span><span class="si">{</span><span class="n">id_agent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;agent_type&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="o">.</span><span class="n">agent_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weight (kg)&quot;</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">measures</span><span class="p">[</span><span class="n">cst</span><span class="o">.</span><span class="n">CommonMeasures</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                <span class="s2">&quot;moi (kg*m^2)&quot;</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">measures</span><span class="p">[</span><span class="s2">&quot;moment_of_inertia&quot;</span><span class="p">],</span>
                <span class="s2">&quot;shapes&quot;</span><span class="p">:</span> <span class="n">agent</span><span class="o">.</span><span class="n">shapes2D</span><span class="o">.</span><span class="n">get_additional_parameters</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">id_agent</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">crowd_dict</span></div>


<div class="viewcode-block" id="Crowd.calculate_interpenetration">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.calculate_interpenetration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_interpenetration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_inflation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total interpenetration area between pedestrians.</span>

<span class="sd">        This method computes the total area of interpenetration between the geometric shapes of pedestrians</span>
<span class="sd">        in the crowd. Optionally, the geometric shapes can be inflated by a buffer before performing the calculation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        with_inflation : bool, optional</span>
<span class="sd">            If True, inflates the geometric shapes by a buffer of 5.0 units before calculating the interpenetration.</span>
<span class="sd">            Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            The total interpenetration area between pedestrians and between pedestrians and boundaries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interpenetration</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">n_agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_number_agents</span><span class="p">()</span>

        <span class="c1"># Loop over all agents in the crowd</span>
        <span class="k">for</span> <span class="n">i_agent</span><span class="p">,</span> <span class="n">current_agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="n">current_geometric</span> <span class="o">=</span> <span class="n">current_agent</span><span class="o">.</span><span class="n">shapes2D</span><span class="o">.</span><span class="n">get_geometric_shape</span><span class="p">()</span>
            <span class="c1"># Inflate the geometric shape if required</span>
            <span class="k">if</span> <span class="n">with_inflation</span><span class="p">:</span>
                <span class="n">current_geometric</span> <span class="o">=</span> <span class="n">current_geometric</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="c1"># Loop over all other agents in the crowd</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i_agent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_agents</span><span class="p">):</span>
                <span class="n">neigh_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">neigh_geometric</span> <span class="o">=</span> <span class="n">neigh_agent</span><span class="o">.</span><span class="n">shapes2D</span><span class="o">.</span><span class="n">get_geometric_shape</span><span class="p">()</span>
                <span class="c1"># Inflate the geometric shape if required</span>
                <span class="k">if</span> <span class="n">with_inflation</span><span class="p">:</span>
                    <span class="n">neigh_geometric</span> <span class="o">=</span> <span class="n">neigh_geometric</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
                <span class="c1"># Calculate interpenetration between current agent and neighbor</span>
                <span class="n">interpenetration</span> <span class="o">+=</span> <span class="n">current_geometric</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">neigh_geometric</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
            <span class="c1"># Calculate interpenetration with the boundaries</span>
            <span class="n">interpenetration</span> <span class="o">+=</span> <span class="n">current_geometric</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>

        <span class="k">return</span> <span class="n">interpenetration</span></div>


<div class="viewcode-block" id="Crowd.calculate_contact_force">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.calculate_contact_force">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_contact_force</span><span class="p">(</span><span class="n">agent_centroid</span><span class="p">:</span> <span class="n">Point</span><span class="p">,</span> <span class="n">other_centroid</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the repulsive force between two centroids.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        agent_centroid : Point</span>
<span class="sd">            The centroid of the agent (Shapely Point object).</span>
<span class="sd">        other_centroid : Point</span>
<span class="sd">            The centroid of the other agent (Shapely Point object).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray[np.float64]</span>
<span class="sd">            The normalized direction of the repulsive force as a 1D NumPy array of floats.</span>
<span class="sd">            If the centroids coincide, a small random force is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract coordinates from Shapely Points and convert them to NumPy arrays</span>
        <span class="n">agent_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent_centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">other_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other_centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Calculate the difference vector between centroids</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">agent_coords</span> <span class="o">-</span> <span class="n">other_coords</span>

        <span class="c1"># Compute the norm (magnitude) of the difference vector</span>
        <span class="n">norm_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>

        <span class="c1"># If the norm is greater than zero, normalize the difference vector</span>
        <span class="k">if</span> <span class="n">norm_delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">norm_delta</span>  <span class="c1"># Return normalized direction of the force</span>

        <span class="c1"># If centroids coincide, return a small random force as a fallback</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="Crowd.calculate_repulsive_force">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.calculate_repulsive_force">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_repulsive_force</span><span class="p">(</span><span class="n">agent_centroid</span><span class="p">:</span> <span class="n">Point</span><span class="p">,</span> <span class="n">other_centroid</span><span class="p">:</span> <span class="n">Point</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the repulsive force between two centroids, exponentially decreasing with distance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        agent_centroid : Point</span>
<span class="sd">            The centroid of the agent (Shapely Point object).</span>
<span class="sd">        other_centroid : Point</span>
<span class="sd">            The centroid of the other agent (Shapely Point object).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NDArray[np.float64]</span>
<span class="sd">            A 1D NumPy array representing the repulsive force vector.</span>
<span class="sd">            If the centroids coincide, a small random force is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract coordinates from Shapely Points and convert them to NumPy arrays</span>
        <span class="n">agent_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent_centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">other_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other_centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Calculate the difference vector between centroids</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">agent_coords</span> <span class="o">-</span> <span class="n">other_coords</span>

        <span class="c1"># Compute the norm (magnitude) of the difference vector</span>
        <span class="n">norm_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>

        <span class="c1"># Handle edge case where centroids coincide (norm_delta == 0)</span>
        <span class="k">if</span> <span class="n">norm_delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># Small random force as fallback</span>

        <span class="c1"># Normalize the difference vector to get the direction of the force</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">norm_delta</span>

        <span class="c1"># Calculate the magnitude of the repulsive force (exponentially decreasing with distance)</span>
        <span class="c1"># TODO : voir comment on peut modifier ce decay depuis streamlit</span>
        <span class="n">force_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">cst</span><span class="o">.</span><span class="n">DEFAULT_DECAY_REPULSION_RATE</span> <span class="o">*</span> <span class="n">norm_delta</span><span class="p">)</span>

        <span class="c1"># Return the repulsive force vector as a NumPy array</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">force_magnitude</span> <span class="o">*</span> <span class="n">direction</span><span class="p">)</span></div>


<div class="viewcode-block" id="Crowd.calculate_rotational_force">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.calculate_rotational_force">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_rotational_force</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a random rotational force value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Random rotational force in degrees between -10.0 and 10.0, inclusive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># Random rotational force between -10 and 10 degrees</span></div>


<div class="viewcode-block" id="Crowd.pack_agents_with_forces">
<a class="viewcode-back" href="../../../shapes.classes.html#shapes.classes.crowd.Crowd.pack_agents_with_forces">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pack_agents_with_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate crowd dynamics by applying physics-based forces between agents.</span>

<span class="sd">        Performs iterative force calculations to separate overlapping agents while</span>
<span class="sd">        maintaining boundary constraints. Implements a cooling system to gradually</span>
<span class="sd">        reduce movement intensity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Temperature</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cst</span><span class="o">.</span><span class="n">MAX_NB_ITERATIONS</span><span class="p">):</span>
            <span class="c1"># Check for overlaps and apply forces if necessary</span>
            <span class="k">for</span> <span class="n">i_agent</span><span class="p">,</span> <span class="n">current_agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
                <span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="n">rotational_force</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">current_geometric</span> <span class="o">=</span> <span class="n">current_agent</span><span class="o">.</span><span class="n">shapes2D</span><span class="o">.</span><span class="n">get_geometric_shape</span><span class="p">()</span>
                <span class="n">current_centroid</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="n">current_geometric</span><span class="o">.</span><span class="n">centroid</span>
                <span class="c1"># Calculate repulsive force between agents</span>
                <span class="k">for</span> <span class="n">j_agent</span><span class="p">,</span> <span class="n">neigh_agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
                    <span class="n">neigh_geometric</span> <span class="o">=</span> <span class="n">neigh_agent</span><span class="o">.</span><span class="n">shapes2D</span><span class="o">.</span><span class="n">get_geometric_shape</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">i_agent</span> <span class="o">!=</span> <span class="n">j_agent</span><span class="p">:</span>
                        <span class="n">neigh_centroid</span><span class="p">:</span> <span class="n">Point</span> <span class="o">=</span> <span class="n">neigh_geometric</span><span class="o">.</span><span class="n">centroid</span>
                        <span class="n">force</span> <span class="o">+=</span> <span class="n">Crowd</span><span class="o">.</span><span class="n">calculate_repulsive_force</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">,</span> <span class="n">neigh_centroid</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">current_geometric</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">neigh_geometric</span><span class="p">):</span>
                            <span class="n">force</span> <span class="o">+=</span> <span class="n">Crowd</span><span class="o">.</span><span class="n">calculate_contact_force</span><span class="p">(</span><span class="n">current_centroid</span><span class="p">,</span> <span class="n">neigh_centroid</span><span class="p">)</span>
                            <span class="n">rotational_force</span> <span class="o">+=</span> <span class="n">Crowd</span><span class="o">.</span><span class="n">calculate_rotational_force</span><span class="p">()</span> <span class="o">*</span> <span class="n">Temperature</span>

                <span class="c1"># TODO : add a possibility to remove wall interaction</span>
                <span class="c1"># Calculate repulsive force between agent and wall</span>
                <span class="c1"># if not self.boundaries.contains(current_geometric):</span>
                <span class="c1">#     nearest_point = np.array(</span>
                <span class="c1">#         self.boundaries.exterior.interpolate(self.boundaries.exterior.project(current_geometric.centroid)).</span>
                <span class="c1">#              coords[0</span>
                <span class="c1">#         ]</span>
                <span class="c1">#     )</span>
                <span class="c1">#     force += Crowd.calculate_contact_force(current_centroid, nearest_point)</span>
                <span class="n">current_agent</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">rotational_force</span><span class="p">)</span>
                <span class="c1"># Apply force to agent position if non-zero and within bounds</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">current_centroid_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">current_centroid</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">new_position</span> <span class="o">=</span> <span class="n">current_centroid_array</span> <span class="o">+</span> <span class="n">force</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">new_position</span><span class="p">)):</span>
                        <span class="n">current_agent</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">force</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">force</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Temperature</span> <span class="o">-=</span> <span class="mf">0.1</span>  <span class="c1"># Decrease the temperature at each iteration</span>
            <span class="n">Temperature</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Temperature</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Oscar Maxime Alexandre.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>